<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理中心 - 云端千年-炎黄新章</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- 头部导航 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">云端千年-炎黄新章</div>
            <nav class="nav-links">
                <a href="index.html">首页</a>
                <a href="register.html">注册</a>
                <a href="login.html">登录</a>
                <a href="dashboard.html">用户中心</a>
                <a href="recharge.html">充值</a>
                <a href="https://1000y.gameivy.com/download.html" target="_blank">下载</a>
                <a href="https://1000y.gameivy.com/" target="_blank">游戏官网</a>
            </nav>
        </div>
    </header>

    <div class="main-content">
        <div class="container" style="max-width: 1400px;">
            <h1 class="game-title">管理中心</h1>

            <div class="card">
                <div id="alert-container"></div>

                <!-- 统计信息 -->
                <div class="stats-container" style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">-</div>
                        <div class="stat-label">总记录</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingCount">-</div>
                        <div class="stat-label">待审核</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="verifiedCount">-</div>
                        <div class="stat-label">已通过</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="rejectedCount">-</div>
                        <div class="stat-label">已拒绝</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalAmount">-</div>
                        <div class="stat-label">总金额(元)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="shenwuAmount">-</div>
                        <div class="stat-label">神武奇章(元)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="yanhuangAmount">-</div>
                        <div class="stat-label">炎黄新章(元)</div>
                    </div>
                </div>

                <!-- 筛选器 -->
                <div class="filter-section" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <select id="statusFilter" class="form-control" style="width: auto; min-width: 150px;">
                        <option value="">全部状态</option>
                        <option value="pending">待审核</option>
                        <option value="verified">已通过</option>
                        <option value="rejected">已拒绝</option>
                    </select>
                    <select id="serverFilter" class="form-control" style="width: auto; min-width: 150px;">
                        <option value="">全部分区</option>
                        <option value="神武奇章">神武奇章</option>
                        <option value="炎黄新章">炎黄新章</option>
                    </select>
                    <select id="itemFilter" class="form-control" style="width: auto; min-width: 150px;">
                        <option value="">全部付款项</option>
                        <option value="月卡">月卡</option>
                        <option value="福袋">福袋</option>
                        <option value="宝石">宝石</option>
                    </select>
                    <input type="text" id="searchInput" class="form-control" placeholder="搜索账号或角色..." style="width: 200px;">
                    <button class="btn btn-primary" onclick="loadRecords()" style="width: auto; padding: 10px 20px;">刷新</button>
                </div>

                <!-- 充值记录列表 -->
                <div class="table-container">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>游戏账号</th>
                                <th>角色名称</th>
                                <th>游戏分区</th>
                                <th>付款项</th>
                                <th>金额</th>
                                <th>付款时间</th>
                                <th>交易单号</th>
                                <th>状态</th>
                                <th>IP地址</th>
                                <th>备注</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody">
                            <tr>
                                <td colspan="12" style="text-align: center; padding: 40px; color: #999;">
                                    <div class="spinner" style="margin: 0 auto 10px;"></div>
                                    加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="prevPage()" id="prevBtn" style="width: auto; padding: 8px 16px;" disabled>上一页</button>
                    <span style="color: #FFD700; display: flex; align-items: center;">第 <span id="currentPage">1</span> 页</span>
                    <button class="btn btn-primary" onclick="nextPage()" id="nextBtn" style="width: auto; padding: 8px 16px;">下一页</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        let currentUser = null;
        let currentPage = 1;
        const pageSize = 20;

        // 页面加载时检查管理员权限
        window.addEventListener('load', function() {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(user);

            // 检查是否为管理员
            if (!currentUser.isAdmin) {
                showAlert('danger', '您没有管理员权限');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
                return;
            }

            loadRecords();
            loadStats();

            // 筛选器事件
            document.getElementById('statusFilter').addEventListener('change', () => {
                currentPage = 1;
                loadRecords();
            });

            document.getElementById('serverFilter').addEventListener('change', () => {
                currentPage = 1;
                loadRecords();
            });

            document.getElementById('itemFilter').addEventListener('change', () => {
                currentPage = 1;
                loadRecords();
            });

            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    currentPage = 1;
                    loadRecords();
                }
            });
        });

        // 加载充值记录
        async function loadRecords() {
            const statusFilter = document.getElementById('statusFilter').value;
            const serverFilter = document.getElementById('serverFilter').value;
            const itemFilter = document.getElementById('itemFilter').value;
            const searchInput = document.getElementById('searchInput').value;
            const tableBody = document.getElementById('recordsTableBody');

            tableBody.innerHTML = `
                <tr>
                    <td colspan="12" style="text-align: center; padding: 40px; color: #999;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        加载中...
                    </td>
                </tr>
            `;

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: pageSize
                });

                if (statusFilter) params.append('status', statusFilter);
                if (serverFilter) params.append('server', serverFilter);
                if (itemFilter) params.append('item', itemFilter);
                if (searchInput) params.append('search', searchInput);

                const token = btoa(encodeURIComponent(JSON.stringify(currentUser)));
                const response = await fetch(`/api/admin/recharge-records?${params}`, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const result = await response.json();

                if (result.success) {
                    displayRecords(result.records);
                    updatePagination(result.hasMore);
                } else {
                    showAlert('danger', result.message);
                    if (result.message.includes('请先登录') || result.message.includes('没有权限')) {
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 1500);
                    }
                }
            } catch (error) {
                console.error('加载充值记录失败:', error);
                showAlert('danger', '加载充值记录失败');
            }
        }

        // 显示充值记录
        function displayRecords(records) {
            const tableBody = document.getElementById('recordsTableBody');

            if (!records || records.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 40px; color: #999;">
                            暂无记录
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = records.map(record => {
                const items = JSON.parse(record.items);
                const statusClass = {
                    'pending': 'status-pending',
                    'verified': 'status-verified',
                    'rejected': 'status-rejected'
                }[record.status];

                const statusText = {
                    'pending': '待审核',
                    'verified': '已通过',
                    'rejected': '已拒绝'
                }[record.status];

                return `
                    <tr>
                        <td>${record.id}</td>
                        <td>${escapeHtml(record.game_account)}</td>
                        <td>${escapeHtml(record.character_name)}</td>
                        <td>${escapeHtml(record.server)}</td>
                        <td>${items.map(i => escapeHtml(i)).join(', ')}</td>
                        <td>￥${parseFloat(record.amount).toFixed(2)}</td>
                        <td>${formatDateTime(record.payment_time)}</td>
                        <td>${escapeHtml(record.transaction_id)}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${escapeHtml(record.ip_address || '-')}</td>
                        <td title="${record.remark ? escapeHtml(record.remark) : '无备注'}">${escapeHtml(record.remark || '-')}</td>
                        <td>
                            ${record.status === 'pending' ? `
                                <button class="btn-approve" onclick="updateStatus(${record.id}, 'verified')">通过</button>
                                <button class="btn-reject" onclick="updateStatus(${record.id}, 'rejected')">拒绝</button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 加载统计信息
        async function loadStats() {
            try {
                const token = btoa(encodeURIComponent(JSON.stringify(currentUser)));
                const response = await fetch('/api/admin/recharge-stats', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('totalCount').textContent = result.stats.total || 0;
                    document.getElementById('pendingCount').textContent = result.stats.pending || 0;
                    document.getElementById('verifiedCount').textContent = result.stats.verified || 0;
                    document.getElementById('rejectedCount').textContent = result.stats.rejected || 0;
                    document.getElementById('totalAmount').textContent = result.stats.totalAmount || '0.00';
                    document.getElementById('shenwuAmount').textContent = result.stats.shenwuAmount || '0.00';
                    document.getElementById('yanhuangAmount').textContent = result.stats.yanhuangAmount || '0.00';
                }
            } catch (error) {
                console.error('加载统计信息失败:', error);
            }
        }

        // 更新充值状态
        async function updateStatus(id, status) {
            if (!confirm(`确定要${status === 'verified' ? '通过' : '拒绝'}此充值申请吗？`)) {
                return;
            }

            try {
                const token = btoa(encodeURIComponent(JSON.stringify(currentUser)));
                const response = await fetch('/api/admin/update-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ id, status })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', result.message);
                    loadRecords();
                    loadStats();
                } else {
                    showAlert('danger', result.message);
                }
            } catch (error) {
                console.error('更新状态失败:', error);
                showAlert('danger', '更新状态失败');
            }
        }

        // 更新分页
        function updatePagination(hasMore) {
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = !hasMore;
        }

        // 上一页
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadRecords();
            }
        }

        // 下一页
        function nextPage() {
            currentPage++;
            loadRecords();
        }

        // 格式化日期时间
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN');
        }

        // HTML转义
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

<style>
/* 管理员页面样式 */
.stats-container {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.stat-card {
    background: rgba(40, 30, 20, 0.5);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 8px;
    padding: 20px;
    min-width: 150px;
    text-align: center;
}

.stat-value {
    color: #FFD700;
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    color: #999;
    font-size: 14px;
}

.table-container {
    overflow-x: auto;
}

.records-table {
    width: 100%;
    border-collapse: collapse;
    color: #E8D4A0;
}

.records-table thead {
    background: rgba(139, 0, 0, 0.5);
}

.records-table th {
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    color: #FFD700;
    border-bottom: 2px solid rgba(212, 175, 55, 0.3);
    white-space: nowrap;
}

/* 备注列特殊样式 */
.records-table th:nth-child(11),
.records-table td:nth-child(11) {
    max-width: 150px;
    min-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.records-table td {
    padding: 12px 8px;
    border-bottom: 1px solid rgba(212, 175, 55, 0.1);
    font-size: 14px;
}

.records-table tbody tr:hover {
    background: rgba(139, 0, 0, 0.2);
}

.status-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.status-pending {
    background: rgba(255, 193, 7, 0.2);
    color: #FFC107;
    border: 1px solid rgba(255, 193, 7, 0.4);
}

.status-verified {
    background: rgba(40, 167, 69, 0.2);
    color: #90EE90;
    border: 1px solid rgba(40, 167, 69, 0.4);
}

.status-rejected {
    background: rgba(220, 53, 69, 0.2);
    color: #FF6B6B;
    border: 1px solid rgba(220, 53, 69, 0.4);
}

.btn-approve, .btn-reject {
    padding: 4px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-right: 5px;
    transition: all 0.3s ease;
}

.btn-approve {
    background: rgba(40, 167, 69, 0.8);
    color: #fff;
}

.btn-approve:hover {
    background: rgba(40, 167, 69, 1);
}

.btn-reject {
    background: rgba(220, 53, 69, 0.8);
    color: #fff;
}

.btn-reject:hover {
    background: rgba(220, 53, 69, 1);
}

@media (max-width: 768px) {
    .records-table {
        font-size: 12px;
    }

    .records-table th,
    .records-table td {
        padding: 8px 4px;
    }
}
</style>
