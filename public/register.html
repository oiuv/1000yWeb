<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å·æ³¨å†Œ - äº‘ç«¯åƒå¹´-ç‚é»„æ–°ç« </title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
        <div class="header-content">
            <div class="logo">äº‘ç«¯åƒå¹´-ç‚é»„æ–°ç« </div>
            <nav class="nav-links">
                <a href="index.html">é¦–é¡µ</a>
                <a href="register.html">æ³¨å†Œ</a>
                <a href="https://1000y.gameivy.com/download.html" target="_blank">å®¢æˆ·ç«¯ä¸‹è½½</a>
                <a href="https://1000y.gameivy.com/" target="_blank">æ¸¸æˆå®˜ç½‘</a>
            </nav>
        </div>
    </header>

    <div class="main-content">
        <div class="container">
            <h1 class="game-title">è´¦å·æ³¨å†Œ</h1>

        <div class="card">
            <h2 class="card-title">è´¦å·æ³¨å†Œ</h2>

            <div id="alert-container"></div>

            <form id="registerForm">
                <div class="form-group">
                    <label for="account" class="form-label required">è´¦å·</label>
                    <input type="text" class="form-control" id="account" name="account"
                           placeholder="è¯·è¾“å…¥5-12ä½è´¦å·" required>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="form-group">
                    <label for="password" class="form-label required">å¯†ç </label>
                    <input type="password" class="form-control" id="password" name="password"
                           placeholder="è¯·è¾“å…¥å¯†ç " required>
                    <div class="password-strength">
                        <div class="password-strength-bar" id="passwordStrength"></div>
                    </div>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword" class="form-label required">ç¡®è®¤å¯†ç </label>
                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                           placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="form-group">
                    <label for="email" class="form-label required">é‚®ç®±</label>
                    <input type="email" class="form-control" id="email" name="email"
                           placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" required>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="form-group">
                    <label for="telephone" class="form-label required">æ‰‹æœºå·ç </label>
                    <input type="tel" class="form-control" id="telephone" name="telephone"
                           placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " required>
                    <div class="invalid-feedback"></div>
                </div>

                <button type="submit" class="btn btn-primary" id="registerBtn">
                    ç«‹å³æ³¨å†Œ
                </button>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    æ­£åœ¨æ³¨å†Œ...
                </div>
            </form>

                    </div>
    </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        // å¯†ç å¼ºåº¦æ£€æµ‹
        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('passwordStrength');

            if (password.length === 0) {
                strengthBar.className = 'password-strength-bar';
                return;
            }

            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            strengthBar.className = 'password-strength-bar';
            if (strength <= 2) {
                strengthBar.classList.add('strength-weak');
            } else if (strength <= 3) {
                strengthBar.classList.add('strength-medium');
            } else {
                strengthBar.classList.add('strength-strong');
            }
        });

        // æ³¨å†Œè¡¨å•å¤„ç†
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            // å®¢æˆ·ç«¯éªŒè¯
            if (!validateForm(data)) {
                return;
            }

            const registerBtn = document.getElementById('registerBtn');
            const loading = document.getElementById('loading');

            registerBtn.disabled = true;
            loading.style.display = 'block';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', result.message);

                    // æ˜¾ç¤ºä¸‹è½½å®¢æˆ·ç«¯æç¤º
                    setTimeout(() => {
                        const downloadMsg = document.createElement('div');
                        downloadMsg.style.cssText = `
                            text-align: center;
                            margin-top: 20px;
                            padding: 15px;
                            background: rgba(40, 167, 69, 0.1);
                            border: 1px solid rgba(40, 167, 69, 0.3);
                            border-radius: 8px;
                            color: #90EE90;
                        `;
                        downloadMsg.innerHTML = `
                            <div style="font-size: 16px; margin-bottom: 10px;">ğŸ® æ³¨å†ŒæˆåŠŸï¼</div>
                            <div style="font-size: 14px; margin-bottom: 15px; line-height: 1.6;">
                                è¯·ä¸‹è½½ç‚é»„æ–°ç« æ¸¸æˆå®¢æˆ·ç«¯ç™»å½•æ¸¸æˆ<br>
                                å¦‚æœ‰ç–‘é—®è¯·åœ¨QQç¾¤ 2887111 äº¤æµ
                            </div>
                            <a href="https://1000y.gameivy.com/download.html" target="_blank"
                               style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                                      color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
                                ä¸‹è½½æ¸¸æˆå®¢æˆ·ç«¯
                            </a>
                        `;

                        // æ’å…¥åˆ°è¡¨å•åé¢
                        const form = document.getElementById('registerForm');
                        form.parentNode.insertBefore(downloadMsg, form.nextSibling);

                        // æ»šåŠ¨åˆ°ä¸‹è½½æç¤º
                        downloadMsg.scrollIntoView({ behavior: 'smooth' });
                    }, 500);
                } else {
                    showAlert('danger', result.message);
                    if (result.errors) {
                        displayErrors(result.errors);
                    }
                }
            } catch (error) {
                showAlert('danger', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•');
                console.error('æ³¨å†Œé”™è¯¯:', error);
            } finally {
                registerBtn.disabled = false;
                loading.style.display = 'none';
            }
        });

        // è¡¨å•éªŒè¯å‡½æ•°
        function validateForm(data) {
            let isValid = true;

            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
            document.querySelectorAll('.form-control').forEach(input => {
                input.classList.remove('is-invalid');
            });
            document.querySelectorAll('.invalid-feedback').forEach(feedback => {
                feedback.style.display = 'none';
            });

            // éªŒè¯è´¦å· (5-12ä½)
            if (!data.account || data.account.length < 5 || data.account.length > 12) {
                showFieldError('account', 'è´¦å·é•¿åº¦å¿…é¡»åœ¨5-12ä¸ªå­—ç¬¦ä¹‹é—´');
                isValid = false;
            } else if (!/^[a-zA-Z0-9_]+$/.test(data.account)) {
                showFieldError('account', 'è´¦å·åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
                isValid = false;
            }

            // éªŒè¯å¯†ç 
            if (!data.password || data.password.length < 6 || data.password.length > 20) {
                showFieldError('password', 'å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä¸ªå­—ç¬¦ä¹‹é—´');
                isValid = false;
            }

            // éªŒè¯ç¡®è®¤å¯†ç 
            if (data.password !== data.confirmPassword) {
                showFieldError('confirmPassword', 'ç¡®è®¤å¯†ç ä¸å¯†ç ä¸åŒ¹é…');
                isValid = false;
            }

            // éªŒè¯é‚®ç®±æ ¼å¼ (å¿…å¡«)
            if (!data.email) {
                showFieldError('email', 'è¯·è¾“å…¥é‚®ç®±åœ°å€');
                isValid = false;
            } else if (!isValidEmail(data.email)) {
                showFieldError('email', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                isValid = false;
            }

            // éªŒè¯æ‰‹æœºå·æ ¼å¼ (å¿…å¡«)
            if (!data.telephone) {
                showFieldError('telephone', 'è¯·è¾“å…¥æ‰‹æœºå·ç ');
                isValid = false;
            } else if (!isValidPhone(data.telephone)) {
                showFieldError('telephone', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ');
                isValid = false;
            }

            return isValid;
        }

        // æ˜¾ç¤ºå­—æ®µé”™è¯¯
        function showFieldError(fieldName, message) {
            const field = document.getElementById(fieldName);
            const feedback = field.nextElementSibling;

            field.classList.add('is-invalid');
            feedback.textContent = message;
            feedback.style.display = 'block';
        }

        // æ˜¾ç¤ºæœåŠ¡å™¨è¿”å›çš„é”™è¯¯
        function displayErrors(errors) {
            errors.forEach(error => {
                const field = document.getElementById(error.param);
                if (field) {
                    showFieldError(error.param, error.msg);
                }
            });
        }
    </script>
</body>
</html>